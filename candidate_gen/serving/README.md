# Candidate Generation Serving

Real-time inference for the candidate generation model.

## Overview

This module provides the `CandidateGenerationService` class that retrieves candidate items for users. It orchestrates:

1. **User embedding lookup** - Retrieves pre-computed user embedding
2. **FAISS search** - Finds nearest items via approximate nearest neighbor search
3. **ID conversion** - Converts internal indices back to original movie IDs

## Quick Start

```python
from candidate_gen.serving import CandidateGenerationService

# Initialize service (loads model and data once)
service = CandidateGenerationService()

# Retrieve candidates for a user
candidates = service.retrieve(user_id=1, k=100)

for item in candidates[:5]:
    print(f"Rank {item.rank}: Movie {item.movie_id} (score: {item.similarity_score:.4f})")
```

Output:
```
Rank 1: Movie 2858 (score: 0.4702)
Rank 2: Movie 2396 (score: 0.3923)
Rank 3: Movie 3527 (score: 0.3882)
Rank 4: Movie 2355 (score: 0.3772)
Rank 5: Movie 1923 (score: 0.3274)
```

## Components

### CandidateGenerationService

Main entry point for candidate retrieval.

```python
class CandidateGenerationService:
    def __init__(self):
        """Initialize with pre-computed artifacts."""

    def retrieve(self, user_id: int, k: int = 100) -> List[RetrievedCandidate]:
        """Retrieve candidates with similarity scores."""

    def retrieve_ids(self, user_id: int, k: int = 100) -> List[int]:
        """Retrieve just movie IDs (lightweight)."""

    def retrieve_batch(self, user_ids: List[int], k: int = 100) -> Dict[int, List[int]]:
        """Retrieve candidates for multiple users."""
```

### RetrievedCandidate

Dataclass for retrieved results:

```python
@dataclass
class RetrievedCandidate:
    movie_id: int
    similarity_score: float
    rank: int  # 1 = best
```

## Data Dependencies

The serving module requires these pre-computed files:

| File | Description | Generated By |
|------|-------------|--------------|
| `candidate_gen/artifacts/index/item_index.faiss` | FAISS index | `build_index.py` |
| `candidate_gen/artifacts/embeddings/user_embeddings.npy` | User embeddings | `build_index.py` |
| `candidate_gen/artifacts/data/user_to_idx.json` | User ID mappings | `prepare_data.py` |
| `candidate_gen/artifacts/data/item_to_idx.json` | Item ID mappings | `prepare_data.py` |
| `candidate_gen/artifacts/models/model_info.json` | Model metadata | `train_model.py` |

## Architecture

```
CandidateGenerationService.retrieve(user_id, k)
    │
    ├─→ ID Mapper: user_id → user_idx
    │
    ├─→ User Embeddings: user_idx → embedding [128-dim]
    │
    ├─→ FAISS Search: find k nearest items
    │
    ├─→ ID Mapper: item_idx → movie_id
    │
    └─→ Return List[RetrievedCandidate]
```

## Performance

Typical latency for retrieving 100 candidates: ~1-5ms (after initialization)

Initialization time: ~0.5-1s (loads FAISS index, embeddings, ID mapper)

## Cold-Start Handling

The service handles unknown users by returning an empty list. For production use, consider:
- Using a popular items fallback
- Computing embeddings on-the-fly for new users (requires model)
